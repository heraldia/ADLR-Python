cscope 16 g:\class\Semester5\research\code\audioAnalyzer\python\dejavu\dejavu"               0000038922
	@__init__.py

1 
äom
 
	gdejavu
.
d©aba£
 
impÜt
 
g‘_d©aba£


2 
impÜt
 
	gdejavu
.
decod”
 
as
 decoder

3 
impÜt
 
fšg”´št


4 
impÜt
 
muÉroûssšg


5 
impÜt
 
os


7 
şass
 
	$Dejavu
(
objeù
):

9 
SONG_ID
 = "song_id"

10 
SONG_NAME
 = 'song_name'

11 
CONFIDENCE
 = 'confidence'

12 
MATCH_TIME
 = 'match_time'

13 
OFFSET
 = 'offset'

15 
def
 
	$__š™__
(
£lf
, 
cÚfig
):

16 
	`su³r
(
Dejavu
, 
£lf
).
	$__š™__
()

18 
£lf
.
cÚfig
 = config

20 #š™Ÿliz
db


21 
db_şs
 = 
	`g‘_d©aba£
(
cÚfig
.
	`g‘
("d©aba£_ty³", 
NÚe
))

23 
£lf
.
db
 = 
	`db_şs
(**
cÚfig
.
	`g‘
("d©aba£", {
	}
}))

24 
	g£lf
.
	gdb
.
	$£tup
()

26 #ià
we
 
should
 
lim™
 
£cÚds
 
fšg”´š‹d
,

27 #NÚe|-1 
m—ns
 
u£
 
’tœe
 
Œack


28 
£lf
.
lim™
 = s–f.
cÚfig
.
	`g‘
("fšg”´št_lim™", 
NÚe
)

29 
£lf
.
lim™
 =ğ-1: #fÜ 
JSON
 
com·tib™y


30 
£lf
.
lim™
 = 
NÚe


31 
£lf
.
	$g‘_fšg”´š‹d_sÚgs
()

33 
def
 
	$g‘_fšg”´š‹d_sÚgs
(
£lf
):

34 #g‘ 
sÚgs
 
´eviou¦y
 
šdexed


35 #TODO: 
should
 
´obably
 
u£
 
a
 
checksum
 
of
 
the
 
fe
 
š¡—d
 oà
f’ame


36 
£lf
.
sÚgs
 = s–f.
db
.
	$g‘_sÚgs
()

37 
£lf
.
sÚgÇmes_£t
 = 
	$£t
(è#tØ
know
 
which
 
Úes
 
we
've computed before

38 
sÚg
 
š
 
£lf
.
sÚgs
:

39 
sÚg_Çme
 = 
sÚg
[
£lf
.
db
.
FIELD_SONGNAME
]

40 
£lf
.
sÚgÇmes_£t
.
	$add
(
sÚg_Çme
)

42 
def
 
	$fšg”´št_dœeùÜy
(
£lf
, 
·th
, 
ex‹nsiÚs
, 
Åroûs£s
=
NÚe
):

43 #Try 
to
 
u£
 
the
 
maximum
 
amouÁ
 
of
 
´oûs£s
 
nÙ
 
giv’
.

44 
Œy
:

45 
Åroûs£s
 =‚´oûs£ 
Ü
 
muÉroûssšg
.
	$ıu_couÁ
()

46 
exû±
 
NÙIm¶em’‹dE¼Ü
:

47 
Åroûs£s
 = 1

49 
Åroûs£s
 = 1 nprocesses <= 0 nprocesses

51 
poŞ
 = 
muÉroûssšg
.
	$PoŞ
(
Åroûs£s
)

53 
f’ames_to_fšg”´št
 = []

54 
f’ame
, 
_
 
š
 
decod”
.
	$fšd_fes
(
·th
, 
ex‹nsiÚs
):

57 
decod”
.
	$·th_to_sÚgÇme
(
f’ame
è
š
 
£lf
.
sÚgÇmes_£t
:

58 
´št
 "% ®»ady fšg”´š‹d, cÚtšušg..." % 
f’ame


61 
f’ames_to_fšg”´št
.
	$­³nd
(
f’ame
)

63 #P»·» 
_fšg”´št_wÜk”
 
šput


64 
wÜk”_šput
 = 
	`z
(
f’ames_to_fšg”´št
,

65 [
£lf
.
lim™
] * 
	$Ën
(
f’ames_to_fšg”´št
))

67 #S’d 
off
 
our
 
sks


68 
™”©Ü
 = 
poŞ
.
	$im­_unÜd”ed
(
_fšg”´št_wÜk”
,

69 
wÜk”_šput
)

71 #Loİ 
tl
 
we
 
have
 
®l
 
of
 
them


72 
True
:

73 
Œy
:

74 
sÚg_Çme
, 
hashes
 = 
™”©Ü
.
	$Ãxt
()

75 
exû±
 
muÉroûssšg
.
TimeoutE¼Ü
:

77 
exû±
 
StİI‹¿tiÚ
:

79 
exû±
:

80 
	`´št
("Failed fingerprinting")

82 #Pršˆ
Œaûback
 
beÿu£
 
we
 
ÿn
't„eraise it here

83 
impÜt
 
Œaûback
, 
sys


84 
Œaûback
.
	$´št_exc
(
fe
=
sys
.
¡dout
)

86 
sid
 = 
£lf
.
db
.
	$š£¹_sÚg
(
sÚg_Çme
)

88 
£lf
.
db
.
	$š£¹_hashes
(
sid
, 
hashes
)

89 
£lf
.
db
.
	$£t_sÚg_fšg”´š‹d
(
sid
)

90 
£lf
.
	$g‘_fšg”´š‹d_sÚgs
()

92 
poŞ
.
	$şo£
()

93 
poŞ
.
	$još
()

95 
def
 
	$fšg”´št_fe
(
£lf
, 
f•©h
, 
sÚg_Çme
=
NÚe
):

97 
sÚgÇme
 = 
decod”
.
	$·th_to_sÚgÇme
(
f•©h
)

98 
sÚg_Çme
 = sÚg_Çm
Ü
 
sÚgÇme


100 
sÚg_Çme
 
š
 
£lf
.
sÚgÇmes_£t
:

101 
´št
 "% ®»ady fšg”´š‹d, cÚtšušg..." % 
sÚg_Çme


103 
sÚg_Çme
, 
hashes
 = 
	$_fšg”´št_wÜk”
(
f•©h
,

104 
£lf
.
lim™
,

105 
sÚg_Çme
=song_name)

107 
sid
 = 
£lf
.
db
.
	$š£¹_sÚg
(
sÚg_Çme
)

109 
£lf
.
db
.
	$š£¹_hashes
(
sid
, 
hashes
)

110 
£lf
.
db
.
	$£t_sÚg_fšg”´š‹d
(
sid
)

111 
£lf
.
	$g‘_fšg”´š‹d_sÚgs
()

113 
def
 
	$fšd_m©ches
(
£lf
, 
§m¶es
, 
Fs
=
fšg”´št
.
DEFAULT_FS
):

114 
hashes
 = 
fšg”´št
.
	$fšg”´št
(
§m¶es
, 
Fs
=Fs)

115  
£lf
.
db
.
	$»tuº_m©ches
(
hashes
)

117 
def
 
	$®ign_m©ches
(
£lf
, 
m©ches
):

119 
Fšds
 
hash
 
m©ches
 
th©
 
®ign
 
š
 
time
 
w™h
 
Ùh”
 m©che 
ªd
 
fšds


120 
cÚ£nsus
 
about
 
which
 
hashes
 
¬e
 "Œue" 
sigÇl
 
äom
 
the
 
audio
.

122 
R‘uºs
 
a
 
diùiÚ¬y
 
w™h
 
m©ch
 
šfÜm©iÚ
.

124 #®igÀ
by
 
diffs


125 
diff_couÁ”
 = {
	}
}

126 
Ïrge¡
 = 0

127 
Ïrge¡_couÁ
 = 0

128 
sÚg_id
 = -1

129 
tup
 
š
 
m©ches
:

130 
sid
, 
	gdiff
 = 
tup


131 
nÙ
 
diff
 
š
 
diff_couÁ”
:

132 
diff_couÁ”
[
diff
] = {}

133 
nÙ
 
sid
 
š
 
diff_couÁ”
[
diff
]:

134 
diff_couÁ”
[
diff
][
sid
] = 0

135 
diff_couÁ”
[
diff
][
sid
] += 1

137 
diff_couÁ”
[
diff
][
sid
] > 
Ïrge¡_couÁ
:

138 
Ïrge¡
 = 
diff


139 
Ïrge¡_couÁ
 = 
diff_couÁ”
[
diff
][
sid
]

140 
sÚg_id
 = 
sid


142 #exŒaù 
id’fiÿtiÚ


143 
sÚg
 = 
£lf
.
db
.
	$g‘_sÚg_by_id
(
sÚg_id
)

144 
sÚg
:

145 #TODO: 
CÏrify
 
wh©
 `
g‘_sÚg_by_id
` 
should
 .

146 
sÚgÇme
 = 
sÚg
.
	$g‘
(
Dejavu
.
SONG_NAME
, 
NÚe
)

148  
NÚe


150 #»tuº 
m©ch
 
šfo


151 
sÚg
 = {

152 
Dejavu
.
SONG_ID
 : 
sÚg_id
,

153 
Dejavu
.
SONG_NAME
 : 
sÚgÇme
,

154 
Dejavu
.
CONFIDENCE
 : 
Ïrge¡_couÁ
,

155 
Dejavu
.
OFFSET
 : 
Ïrge¡
 
	}
}

157  
sÚg


159 
def
 
	$»cognize
(
£lf
, 
»cogniz”
, *
İtiÚs
, **
kwİtiÚs
):

160 
r
 = 
	$»cogniz”
(
£lf
)

161  
r
.
	$»cognize
(*
İtiÚs
, **
kwİtiÚs
)

164 
def
 
	$_fšg”´št_wÜk”
(
f’ame
, 
lim™
=
NÚe
, 
sÚg_Çme
=None):

165 #PoŞ.
im­
 
£nds
 
¬gum’ts
 
as
 
tu¶es
 
so
 
we
 
have
 
to
 
uÅack


166 #them 
our£lf
.

167 
Œy
:

168 
f’ame
, 
lim™
 = filename

169 
exû±
 
V®ueE¼Ü
:

170 
·ss


172 
sÚgÇme
, 
ex‹nsiÚ
 = 
os
.
·th
.
	`¥l™ext
(os.·th.
	$ba£Çme
(
f’ame
))

174 
sÚg_Çme
 = sÚg_Çm
Ü
 
sÚgÇme


176 
chªÃls
, 
Fs
 = 
decod”
.
	$»ad
(
f’ame
, 
lim™
)

178 
»suÉ
 = 
	$£t
()

180 
chªÃl_amouÁ
 = 
	$Ën
(
chªÃls
)

181 
chªÃÊ
, 
chªÃl
 
š
 
	$’um”©e
(
chªÃls
):

182 #TODO: 
Remove
 
´šts
 
Ü
 
chªge
 
them
 
što
 
İtiÚ®
 
loggšg
.

183 
	`´št
("Fšg”´štšg chªÃÈ%d/%d fÜ %s" % (
chªÃÊ
 + 1,

184 
chªÃl_amouÁ
,

185 
f’ame
))

186 
hashes
 = 
fšg”´št
.
	$fšg”´št
(
chªÃl
, 
Fs
=Fs)

187 
	`´št
("Fšished chªÃÈ%d/%d fÜ %s" % (
chªÃÊ
 + 1, 
chªÃl_amouÁ
,

188 
f’ame
))

190 
»suÉ
 |ğ
	$£t
(
hashes
)

192  
sÚg_Çme
, 
»suÉ


195 
def
 
	$chunkify
(
l¡
, 
n
):

197 
S¶™s
 
a
 
li¡
 
što
 
roughly
 
n
 
equ®
 
·¹s
.

198 
h‰p
:

200  [
l¡
[
i
::
n
] ˜
š
 
	`x¿nge
(n)]

	@database.py

1 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


2 
impÜt
 
abc


5 
şass
 
	$D©aba£
(
objeù
):

6 
__m‘aşass__
 = 
abc
.
ABCM‘a


8 #Nam
of
 
your
 
D©aba£
 
subşass
, 
this
 
is
 
u£d
 
š
 
cÚfigu¿tiÚ


9 #tØ
»ãr
 
to
 
your
 
şass


10 
ty³
 = 
NÚe


12 
def
 
	$__š™__
(
£lf
):

13 
	`su³r
(
D©aba£
, 
£lf
).
	$__š™__
()

15 
def
 
	$befÜe_fÜk
(
£lf
):

17 
C®Ëd
 
befÜe
 
the
 
d©aba£
 
š¡ªû
 
is
 
giv’
 
to
h
Ãw
 
´oûss


19 
·ss


21 
def
 
	$aá”_fÜk
(
£lf
):

23 
C®Ëd
 
aá”
 
the
 
d©aba£
 
š¡ªû
 
has
 
b“n
 
giv’
 
to
h
Ãw
 
´oûss


25 
This
 
wl
 
be
 
ÿÎed
 
š
 
the
 
Ãw
 
´oûss
.

27 
·ss


29 
def
 
	$£tup
(
£lf
):

31 
C®Ëd
 
Ú
 
ü—tiÚ
 
Ü
 
shÜy
 
aá”w¬ds
.

33 
·ss


35 @
abc
.
ab¡¿ùm‘hod


36 
def
 
	$em±y
(
£lf
):

38 
C®Ëd
 
wh’
 
the
 
d©aba£
 
should
 
be
 
ş—»d
 
of
 
®l
 
d©a
.

40 
·ss


42 @
abc
.
ab¡¿ùm‘hod


43 
def
 
	$d–‘e_unfšg”´š‹d_sÚgs
(
£lf
):

45 
C®Ëd
 
to
 
»move
 
ªy
 
sÚg
 
’Œ›s
 
th©
 dØ
nÙ
 
have
‡ny 
fšg”´šts


46 
assocŸ‹d
 
w™h
 
them
.

48 
·ss


50 @
abc
.
ab¡¿ùm‘hod


51 
def
 
	$g‘_num_sÚgs
(
£lf
):

53 
R‘uºs
 
the
 
amouÁ
 
of
 
sÚgs
 
š
h
d©aba£
.

55 
·ss


57 @
abc
.
ab¡¿ùm‘hod


58 
def
 
	$g‘_num_fšg”´šts
(
£lf
):

60 
R‘uºs
 
the
 
numb”
 
of
 
fšg”´šts
 
š
h
d©aba£
.

62 
·ss


64 @
abc
.
ab¡¿ùm‘hod


65 
def
 
	$£t_sÚg_fšg”´š‹d
(
£lf
, 
sid
):

67 
S‘s
 
a
 
¥ecific
 
sÚg
 
as
 
havšg
 
®l
 
fšg”´šts
 
š
 
the
 
d©aba£
.

69 
sid
: 
SÚg
 
id’tif›r


71 
·ss


73 @
abc
.
ab¡¿ùm‘hod


74 
def
 
	$g‘_sÚgs
(
£lf
):

76 
R‘uºs
 
®l
 
fuÎy
 
fšg”´š‹d
 
sÚgs
 
š
 
the
 
d©aba£
.

78 
·ss


80 @
abc
.
ab¡¿ùm‘hod


81 
def
 
	$g‘_sÚg_by_id
(
£lf
, 
sid
):

83 
R‘uº
 
a
 
sÚg
 
by
 
™s
 
id’tif›r


85 
sid
: 
SÚg
 
id’tif›r


87 
·ss


89 @
abc
.
ab¡¿ùm‘hod


90 
def
 
	$š£¹
(
£lf
, 
hash
, 
sid
, 
off£t
):

92 
In£¹s
 
a
 
sšgË
 
fšg”´št
 
što
 
the
 
d©aba£
.

94 
hash
: 
P¬t
 
of
 
a
 
sha1
 hash, 
š
 
hexadecim®
 
fÜm©


95 
sid
: 
SÚg
 
id’tif›r
 
this
 
fšg”´št
 
is
 
off


96 
off£t
: 
The
 off£ˆ
this
 
hash
 
is
 
äom


98 
·ss


100 @
abc
.
ab¡¿ùm‘hod


101 
def
 
	$š£¹_sÚg
(
£lf
, 
sÚg_Çme
):

103 
In£¹s
 
a
 
sÚg
 
Çme
 
što
 
the
 
d©aba£
, 
»tuºs
h
Ãw


104 
id’tif›r
 
of
 
the
 
sÚg
.

106 
sÚg_Çme
: 
The
 
Çme
 
of
 
the
 
sÚg
.

108 
·ss


110 @
abc
.
ab¡¿ùm‘hod


111 
def
 
	$qu”y
(
£lf
, 
hash
):

113 
R‘uºs
 
®l
 
m©chšg
 
fšg”´št
 
’Œ›s
 
assocŸ‹d
 
w™h


114 
the
 
giv’
 
hash
 
as
 
·¿m‘”
.

116 
hash
: 
P¬t
 
of
 
a
 
sha1
 hash, 
š
 
hexadecim®
 
fÜm©


118 
·ss


120 @
abc
.
ab¡¿ùm‘hod


121 
def
 
	$g‘_™”abË_kv_·œs
(
£lf
):

123 
R‘uºs
 
®l
 
fšg”´šts
 
š
 
the
 
d©aba£
.

125 
·ss


127 @
abc
.
ab¡¿ùm‘hod


128 
def
 
	$š£¹_hashes
(
£lf
, 
sid
, 
hashes
):

130 
In£¹
 
a
 
muÉ™ude
 
of
 
fšg”´šts
.

132 
sid
: 
SÚg
 
id’tif›r
 
the
 
fšg”´šts
 
b–Úg
 
to


133 
hashes
: 
A
 
£qu’û
 
of
 
tu¶es
 
š
 
the
 
	`fÜm©
 (
hash
, 
off£t
)

134 - 
hash
: 
P¬t
 
of
 
a
 
sha1
 hash, 
š
 
hexadecim®
 
fÜm©


135 - 
off£t
: 
Off£t
 
this
 
hash
 
was
 
ü—‹d
 
äom
/
©
.

137 
·ss


139 @
abc
.
ab¡¿ùm‘hod


140 
def
 
	$»tuº_m©ches
(
£lf
, 
hashes
):

142 
S—rches
 
the
 
d©aba£
 
·œs
 
	$of
 (
hash
, 
off£t
è
v®ues
.

144 
hashes
: 
A
 
£qu’û
 
of
 
tu¶es
 
š
 
the
 
	`fÜm©
 (
hash
, 
off£t
)

145 - 
hash
: 
P¬t
 
of
 
a
 
sha1
 hash, 
š
 
hexadecim®
 
fÜm©


146 - 
off£t
: 
Off£t
 
this
 
hash
 
was
 
ü—‹d
 
äom
/
©
.

148 
R‘uºs
 
a
 
£qu’û
 
	$of
 (
sid
, 
off£t_difã»nû
è
tu¶es
.

150 
sid
: 
SÚg
 
id’tif›r


151 
off£t_difã»nû
: (
off£t
 - 
d©aba£_off£t
)

153 
·ss


156 
def
 
	$g‘_d©aba£
(
d©aba£_ty³
=
NÚe
):

157 #DeçuÉ 
to
 
usšg
 
the
 
mysql
 
d©aba£


158 
d©aba£_ty³
 = d©aba£_ty³ 
Ü
 "mysql"

159 #Low” 
®l
 
the
 
šput
.

160 
d©aba£_ty³
 = d©aba£_ty³.
	$low”
()

162 
db_şs
 
š
 
D©aba£
.
	$__subşas£s__
():

163 
db_şs
.
ty³
 =ğ
d©aba£_ty³
:

164  
db_şs


166 
¿i£
 
	`Ty³E¼Ü
("Unsupported databaseype supplied.")

169 #ImpÜˆ
our
  
d©aba£
 
hªdËr


170 
impÜt
 
dejavu
.
d©aba£_sql


	@database_sql.py

1 
äom
 
__futu»__
 
impÜt
 
absŞu‹_impÜt


2 
äom
 
™”toŞs
 
impÜt
 
iz_lÚge¡


3 
impÜt
 
Queue


5 
impÜt
 
MySQLdb
 
as
 
mysql


6 
äom
 
	gMySQLdb
.
cursÜs
 
impÜt
 
DiùCursÜ


8 
äom
 
	gdejavu
.
d©aba£
 
impÜt
 
D©aba£


11 
şass
 
	$SQLD©aba£
(
D©aba£
):

13 
Qu”›s
:

15 1è
Fšd
 
	`du¶iÿ‹s
 (
shouldn
't be‡ny,hough):

17 
£Ëù
 `
hash
`, `
sÚg_id
`, `
off£t
`, 
	$couÁ
(*è
út


18 
äom
 
fšg”´šts


19 
group
 
by
 `
hash
`, `
sÚg_id
`, `
off£t
`

20 
havšg
 
út
 > 1

21 
Üd”
 
by
 
út
 
asc
;

23 2è
G‘
 
numb”
 
of
 
hashes
 
by
 
sÚg
:

25 
£Ëù
 
sÚg_id
, 
sÚg_Çme
, 
	$couÁ
(
sÚg_id
è
as
 
num


26 
äom
 
fšg”´šts


27 
Çtu¿l
 
još
 
sÚgs


28 
group
 
by
 
sÚg_id


29 
Üd”
 
by
 
	$couÁ
(
sÚg_id
è
desc
;

31 3è
g‘
 
hashes
 
w™h
 
highe¡
 
numb”
 
of
 
cŞlisiÚs


33 
£Ëù


34 
hash
,

35 
	$couÁ
(
di¡šù
 
sÚg_id
è
as
 
n


36 
äom
 
fšg”´šts


37 
group
 
by
 `
hash
`

38 
Üd”
 
by
 
n
 
DESC
;

40 => 26 
difã»Á
 
sÚgs
 
w™h
 
§me
 
	`fšg”´št
 (392 
times
):

42 
£Ëù
 
sÚgs
.
sÚg_Çme
, 
fšg”´šts
.
off£t


43 
äom
 
fšg”´šts
 
Çtu¿l
 
još
 
sÚgs


44 
wh”e
 
fšg”´šts
.
hash
 = "08d3c833b71c60a7b620322ac0c0aba7bf5a3e73";

47 
ty³
 = "mysql"

50 
FINGERPRINTS_TABLENAME
 = "fingerprints"

51 
SONGS_TABLENAME
 = "songs"

54 
FIELD_HASH
 = "hash"

55 
FIELD_SONG_ID
 = "song_id"

56 
FIELD_OFFSET
 = "offset"

57 
FIELD_SONGNAME
 = "song_name"

58 
FIELD_FINGERPRINTED
 = "fingerprinted"

61 
CREATE_FINGERPRINTS_TABLE
 = """

62 
CREATE
 
TABLE
 
IF
 
NOT
 
EXISTS
 `%
s
` (

63 `%
s
` 
	`bš¬y
(10è
nÙ
 
nuÎ
,

64 `%
s
` 
mediumšt
 
nÙ
 
nuÎ
,

65 `%
s
` 
nÙ
 
nuÎ
,

66 
	`INDEX
 (%
s
),

67 
UNIQUE
 
KEY
 `
unique_cÚ¡¿št
` (%
s
, %s, %s),

68 
FOREIGN
 
	`KEY
 (%
s
è
REFERENCES
 %
	`s
(%sè
ON
 
DELETE
 
CASCADE


69 è
ENGINE
=
INNODB
;""" % (

70 
FINGERPRINTS_TABLENAME
, 
FIELD_HASH
,

71 
FIELD_SONG_ID
, 
FIELD_OFFSET
, 
FIELD_HASH
,

72 
FIELD_SONG_ID
, 
FIELD_OFFSET
, 
FIELD_HASH
,

73 
FIELD_SONG_ID
, 
SONGS_TABLENAME
, FIELD_SONG_ID

76 
CREATE_SONGS_TABLE
 = """

77 
CREATE
 
TABLE
 
IF
 
NOT
 
EXISTS
 `%
s
` (

78 `%
s
` 
mediumšt
 
nÙ
 
nuÎ
 
auto_šüem’t
,

79 `%
s
` 
	`v¬ch¬
(250è
nÙ
 
nuÎ
,

80 `%
s
` 
tšyšt
  0,

81 
PRIMARY
 
	`KEY
 (`%
s
`),

82 
UNIQUE
 
KEY
 `%
s
` (`%s`)

83 è
ENGINE
=
INNODB
;""" % (

84 
SONGS_TABLENAME
, 
FIELD_SONG_ID
, 
FIELD_SONGNAME
, 
FIELD_FINGERPRINTED
,

85 
FIELD_SONG_ID
, FIELD_SONG_ID, FIELD_SONG_ID,

88 #š£¹ (
ignÜes
 
du¶iÿ‹s
)

89 
INSERT_FINGERPRINT
 = """

90 
INSERT
 
IGNORE
 
INTO
 %
	`s
 (%
s
, %s, %sè
v®ues


91 (
	`UNHEX
(%%
s
), %%s, %%s);

94 
INSERT_SONG
 = "INSERT INTO %s (%s) values (%%s);" % (

95 
SONGS_TABLENAME
, 
FIELD_SONGNAME
)

98 
SELECT
 = """

99 
SELECT
 %
s
, % 
FROM
 % 
WHERE
 % ğ
	`UNHEX
(%%s);

102 
SELECT_MULTIPLE
 = """

103 
SELECT
 
	`HEX
(%
s
), %s, % 
FROM
 % 
WHERE
 % 
	`IN
 (%%s);

105 
FINGERPRINTS_TABLENAME
, 
FIELD_HASH
)

107 
SELECT_ALL
 = """

108 
SELECT
 %
s
, % 
FROM
 %s;

111 
SELECT_SONG
 = """

112 
SELECT
 %
s
 
FROM
 % 
WHERE
 %s = %%s

115 
SELECT_NUM_FINGERPRINTS
 = """

116 
SELECT
 
	$COUNT
(*è
as
 
n
 
FROM
 %
s


119 
SELECT_UNIQUE_SONG_IDS
 = """

120 
SELECT
 
	`COUNT
(
DISTINCT
 %
s
è
as
 
n
 
FROM
 % 
WHERE
 %s = 1;

123 
SELECT_SONGS
 = """

124 
SELECT
 %
s
, % 
FROM
 % 
WHERE
 %s = 1;

128 
DROP_FINGERPRINTS
 = "DROP TABLE IF EXISTS %s;" % 
FINGERPRINTS_TABLENAME


129 
DROP_SONGS
 = "DROP TABLE IF EXISTS %s;" % 
SONGS_TABLENAME


132 
UPDATE_SONG_FINGERPRINTED
 = """

133 
UPDATE
 %
s
 
SET
 % ğ1 
WHERE
 %s = %%s

137 
DELETE_UNFINGERPRINTED
 = """

138 
DELETE
 
FROM
 %
s
 
WHERE
 %s = 0;

141 
def
 
	$__š™__
(
£lf
, **
İtiÚs
):

142 
	`su³r
(
SQLD©aba£
, 
£lf
).
	$__š™__
()

143 
£lf
.
cursÜ
 = 
	$cursÜ_çùÜy
(**
İtiÚs
)

144 
£lf
.
_İtiÚs
 = 
İtiÚs


146 
def
 
	$aá”_fÜk
(
£lf
):

147 #CË¬ 
the
 
cursÜ
 
ÿche
, 
we
 
dÚ
't want‡ny stale connections from

148 #th
´evious
 
´oûss
.

149 
CursÜ
.
	$ş—r_ÿche
()

151 
def
 
	$£tup
(
£lf
):

153 
C»©es
 
ªy
 
nÚ
-
exi¡šg
 
bËs
 
»quœed
 
dejavu
 
to
 
funùiÚ
.

155 
This
 
®so
 
»moves
 
®l
 
sÚgs
 
th©
 
have
 
b“n
 
added
 
but
 hav
no


156 
fšg”´šts
 
assocŸ‹d
 
w™h
 
them
.

158 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

159 
cur
.
	$execu‹
(
£lf
.
CREATE_SONGS_TABLE
)

160 
cur
.
	$execu‹
(
£lf
.
CREATE_FINGERPRINTS_TABLE
)

161 
cur
.
	$execu‹
(
£lf
.
DELETE_UNFINGERPRINTED
)

163 
def
 
	$em±y
(
£lf
):

165 
Drİs
 
bËs
 
ü—‹d
 
by
 
dejavu
 
ªd
 
th’
 
ü—‹s
 
them
 
agaš


166 
by
 
ÿÎšg
 `
SQLD©aba£
.
£tup
`.

168 .. 
w¬nšg
:

169 
This
 
wl
 
»suÉ
 
š
 
a
 
loss
 
of
 
d©a


171 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

172 
cur
.
	$execu‹
(
£lf
.
DROP_FINGERPRINTS
)

173 
cur
.
	$execu‹
(
£lf
.
DROP_SONGS
)

175 
£lf
.
	$£tup
()

177 
def
 
	$d–‘e_unfšg”´š‹d_sÚgs
(
£lf
):

179 
Removes
 
®l
 
sÚgs
 
th©
 
have
 
no
 
fšg”´šts
 
assocŸ‹d
 
w™h
 
them
.

181 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

182 
cur
.
	$execu‹
(
£lf
.
DELETE_UNFINGERPRINTED
)

184 
def
 
	$g‘_num_sÚgs
(
£lf
):

186 
R‘uºs
 
numb”
 
of
 
sÚgs
 
the
 
d©aba£
 
has
 
fšg”´š‹d
.

188 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

189 
cur
.
	$execu‹
(
£lf
.
SELECT_UNIQUE_SONG_IDS
)

191 
couÁ
, 
š
 
cur
:

192  
couÁ


195 
def
 
	$g‘_num_fšg”´šts
(
£lf
):

197 
R‘uºs
 
numb”
 
of
 
fšg”´šts
 
the
 
d©aba£
 
has
 
fšg”´š‹d
.

199 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

200 
cur
.
	$execu‹
(
£lf
.
SELECT_NUM_FINGERPRINTS
)

202 
couÁ
, 
š
 
cur
:

203  
couÁ


206 
def
 
	$£t_sÚg_fšg”´š‹d
(
£lf
, 
sid
):

208 
S‘
 
the
 
fšg”´š‹d
 
æag
 
to
 
	`TRUE
 (1è
Úû
 
a
 
sÚg
 
has
 
b“n
 
com¶‘–y


209 
fšg”´š‹d
 
š
 
the
 
d©aba£
.

211 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

212 
cur
.
	`execu‹
(
£lf
.
UPDATE_SONG_FINGERPRINTED
, (
sid
,))

214 
def
 
	$g‘_sÚgs
(
£lf
):

216 
R‘uº
 
sÚgs
 
th©
 
have
 
the
 
fšg”´š‹d
 
æag
 
£t
 
	`TRUE
 (1).

218 
w™h
 
£lf
.
	$cursÜ
(
cursÜ_ty³
=
DiùCursÜ
è
as
 
cur
:

219 
cur
.
	$execu‹
(
£lf
.
SELECT_SONGS
)

220 
row
 
š
 
cur
:

221 
y›ld
 
row


223 
def
 
	$g‘_sÚg_by_id
(
£lf
, 
sid
):

225 
R‘uºs
 
sÚg
 
by
 
™s
 
ID
.

227 
w™h
 
£lf
.
	$cursÜ
(
cursÜ_ty³
=
DiùCursÜ
è
as
 
cur
:

228 
cur
.
	`execu‹
(
£lf
.
SELECT_SONG
, (
sid
,))

229  
cur
.
	$ãtchÚe
()

231 
def
 
	$š£¹
(
£lf
, 
hash
, 
sid
, 
off£t
):

233 
In£¹
 
	$a
 (
sha1
, 
sÚg_id
, 
off£t
è
row
 
što
 
d©aba£
.

235 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

236 
cur
.
	`execu‹
(
£lf
.
INSERT_FINGERPRINT
, (
hash
, 
sid
, 
off£t
))

238 
def
 
	$š£¹_sÚg
(
£lf
, 
sÚgÇme
):

240 
In£¹s
 
sÚg
 
š
 
the
 
d©aba£
 
ªd
 
»tuºs
h
ID
 
of
h
š£¹ed
 
»cÜd
.

242 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

243 
cur
.
	`execu‹
(
£lf
.
INSERT_SONG
, (
sÚgÇme
,))

244  
cur
.
Ï¡rowid


246 
def
 
	$qu”y
(
£lf
, 
hash
):

248 
R‘uº
 
®l
 
tu¶es
 
assocŸ‹d
 
w™h
 
hash
.

250 
If
 
hash
 
is
 
NÚe
, 
»tuºs
 
®l
 
’Œ›s
 
š
 
the


251 
	`d©aba£
 (
be
 
ÿ»ful
 
w™h
 
th©
 
Úe
!).

253 #£Ëù 
®l
 
no
 
key


254 
qu”y
 = 
£lf
.
SELECT_ALL
 
hash
 
is
 
NÚe
 £lf.
SELECT


256 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

257 
cur
.
	$execu‹
(
qu”y
)

258 
sid
, 
off£t
 
š
 
cur
:

259 
	$y›ld
 (
sid
, 
off£t
)

261 
def
 
	$g‘_™”abË_kv_·œs
(
£lf
):

263 
R‘uºs
 
®l
 
tu¶es
 
š
 
d©aba£
.

265  
£lf
.
	$qu”y
(
NÚe
)

267 
def
 
	$š£¹_hashes
(
£lf
, 
sid
, 
hashes
):

269 
In£¹
 
£r›s
 
of
 
hash
 => 
sÚg_id
, 
off£t


270 
v®ues
 
što
 
the
 
d©aba£
.

272 
v®ues
 = []

273 
hash
, 
off£t
 
š
 
hashes
:

274 
v®ues
.
	`­³nd
((
hash
, 
sid
, 
off£t
))

276 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

277 
¥l™_v®ues
 
š
 
	`grou³r
(
v®ues
, 1000):

278 
cur
.
	$execu‹mªy
(
£lf
.
INSERT_FINGERPRINT
, 
¥l™_v®ues
)

280 
def
 
	$»tuº_m©ches
(
£lf
, 
hashes
):

282 
R‘uº
 
	$the
 (
sÚg_id
, 
off£t_diff
è
tu¶es
 
assocŸ‹d
 
w™h


283 
a
 
li¡
 
	$of
 (
sha1
, 
§m¶e_off£t
è
v®ues
.

285 #C»©
a
 
diùiÚ¬y
 
of
 
hash
 => 
off£t
 
·œs
 
Ï‹r
 
lookups


286 
m­³r
 = {
	}
}

287 
hash
, 
off£t
 
š
 
	ghashes
:

288 
m­³r
[
hash
.
uµ”
()] = 
off£t


290 #G‘ 
ª
 
™”©abË
 
of
 
®l
 
the
 
hashes
 
we
 
Ãed


291 
v®ues
 = 
m­³r
.
	$keys
()

293 
w™h
 
£lf
.
	$cursÜ
(è
as
 
cur
:

294 
¥l™_v®ues
 
š
 
	`grou³r
(
v®ues
, 1000):

295 #C»©
our
 
IN
 
·¹
 
of
 
the
 
qu”y


296 
qu”y
 = 
£lf
.
SELECT_MULTIPLE


297 
qu”y
 = qu”y % ', '.
	`još
(['UNHEX(%s)'] * 
	$Ën
(
¥l™_v®ues
))

299 
cur
.
	$execu‹
(
qu”y
, 
¥l™_v®ues
)

301 
hash
, 
sid
, 
off£t
 
š
 
cur
:

302 #(
sid
, 
db_off£t
 - 
sÚg_§m¶ed_off£t
)

303 
	`y›ld
 (
sid
, 
off£t
 - 
m­³r
[
hash
])

305 
def
 
	$__g‘¡©e__
(
£lf
):

306  (
£lf
.
_İtiÚs
,)

308 
def
 
	$__£t¡©e__
(
£lf
, 
¡©e
):

309 
£lf
.
_İtiÚs
, = 
¡©e


310 
£lf
.
cursÜ
 = 
	$cursÜ_çùÜy
(**
£lf
.
_İtiÚs
)

313 
def
 
	$grou³r
(
™”abË
, 
n
, 
flv®ue
=
NÚe
):

314 
¬gs
 = [
	`™”
(
™”abË
)] * 
n


315  (
	$f‹r
(
NÚe
, 
v®ues
) values

316 
š
 
	$iz_lÚge¡
(
flv®ue
=flv®ue, *
¬gs
))

319 
def
 
	$cursÜ_çùÜy
(**
çùÜy_İtiÚs
):

320 
def
 
	$cursÜ
(**
İtiÚs
):

321 
İtiÚs
.
	$upd©e
(
çùÜy_İtiÚs
)

322  
	$CursÜ
(**
İtiÚs
)

323  
cursÜ


326 
şass
 
	$CursÜ
(
objeù
):

328 
E¡ablishes
 
a
 
cÚÃùiÚ
 
to
 
the
 
d©aba£
 
ªd
 
»tuºs
 
ª
 
İ’
 
cursÜ
.

331 ```
pythÚ


332 #U£ 
as
 
cÚ‹xt
 
mªag”


333 
w™h
 
	$CursÜ
(è
as
 
cur
:

334 
cur
.
	`execu‹
(
qu”y
)

337 
_ÿche
 = 
Queue
.
	`Queue
(
maxsize
=5)

339 
def
 
	$__š™__
(
£lf
, 
cursÜ_ty³
=
mysql
.
cursÜs
.
CursÜ
, **
İtiÚs
):

340 
	`su³r
(
CursÜ
, 
£lf
).
	$__š™__
()

342 
Œy
:

343 
cÚn
 = 
£lf
.
_ÿche
.
	$g‘_nowa™
()

344 
exû±
 
Queue
.
Em±y
:

345 
cÚn
 = 
mysql
.
	$cÚÃù
(**
İtiÚs
)

347 #Pšg 
the
 
cÚÃùiÚ
 
befÜe
 
usšg
 
™
 
äom
h
ÿche
.

348 
cÚn
.
	$pšg
(
True
)

350 
£lf
.
cÚn
 = conn

351 
£lf
.
cÚn
.
	$autocomm™
(
F®£
)

352 
£lf
.
cursÜ_ty³
 = cursor_type

354 @
şassm‘hod


355 
def
 
	$ş—r_ÿche
(
şs
):

356 
şs
.
_ÿche
 = 
Queue
.
	`Queue
(
maxsize
=5)

358 
def
 
	$__’‹r__
(
£lf
):

359 
£lf
.
cursÜ
 = s–f.
cÚn
.
	$cursÜ
(
£lf
.
cursÜ_ty³
)

360  
£lf
.
cursÜ


362 
def
 
	$__ex™__
(
£lf
, 
exty³
, 
exv®ue
, 
Œaûback
):

363 #ià
we
 
had
 
a
 
MySQL
 
»Ï‹d
 
”rÜ
 w
Œy
 
to
 
rŞlback
 
the
 
cursÜ
.

364 
exty³
 
is
 
mysql
.
MySQLE¼Ü
:

365 
£lf
.
cursÜ
.
	$rŞlback
()

367 
£lf
.
cursÜ
.
	$şo£
()

368 
£lf
.
cÚn
.
	$comm™
()

370 #Puˆ
™
 
back
 
Ú
 
the
 
queue


371 
Œy
:

372 
£lf
.
_ÿche
.
	$put_nowa™
(
£lf
.
cÚn
)

373 
exû±
 
Queue
.
FuÎ
:

374 
£lf
.
cÚn
.
	`şo£
()

	@decoder.py

1 
impÜt
 
os


2 
impÜt
 
âm©ch


3 
impÜt
 
numpy
 
as
 
Å


4 
äom
 
pydub
 
impÜt
 
AudioSegm’t


7 
def
 
	$fšd_fes
(
·th
, 
ex‹nsiÚs
):

8 #AÎow 
bÙh
 
w™h
 ".mp3" 
ªd
 
w™hout
 "mp3" 
to
 
be
 
u£d
 
ex‹nsiÚs


9 
ex‹nsiÚs
 = [
e
.
	`»¶aû
(".", ""è
š
ƒxtensions]

11 
dœ·th
, 
dœÇmes
, 
fes
 
š
 
os
.
	$w®k
(
·th
):

12 
ex‹nsiÚ
 
š
 
ex‹nsiÚs
:

13 
f
 
š
 
âm©ch
.
	`f‹r
(
fes
, "*.%s" % 
ex‹nsiÚ
):

14 
p
 = 
os
.
·th
.
	$još
(
dœ·th
, 
f
)

15 
	$y›ld
 (
p
, 
ex‹nsiÚ
)

18 
def
 
	$»ad
(
f’ame
, 
lim™
=
NÚe
):

20 
R—ds
 
ªy
 
fe
 
suµÜ‹d
 
by
 
	$pydub
 (
ffm³g
è
ªd
 
»tuºs
 
the
 
d©a
 
cÚšed


21 
w™hš
.

23 
Cª
 
be
 
İtiÚ®ly
 
lim™ed
 
to
 
a
 
û¹aš
 
amouÁ
 
of
 
£cÚds
 
äom
 
the
 
¡¬t


24 
of
 
the
 
fe
 
by
 
¥ecifyšg
h`
lim™
` 
·¿m‘”
. 
This
 
is
h
amouÁ
 of

25 
£cÚds
 
äom
 
the
 
¡¬t
 
of
h
fe
.

27 
»tuºs
: (
chªÃls
, 
§m¶”©e
)

29 
audiofe
 = 
AudioSegm’t
.
	$äom_fe
(
f’ame
)

31 
lim™
:

32 
audiofe
 =‡udiofe[:
lim™
 * 1000]

34 
d©a
 = 
Å
.
	$äom¡ršg
(
audiofe
.
_d©a
, 
Å
.
št16
)

36 
chªÃls
 = []

37 
chn
 
š
 
	$x¿nge
(
audiofe
.
chªÃls
):

38 
chªÃls
.
	`­³nd
(
d©a
[
chn
::
audiofe
.channels])

40  
chªÃls
, 
audiofe
.
äame_¿‹


43 
def
 
	$·th_to_sÚgÇme
(
·th
):

45 
ExŒaùs
 
sÚg
 
Çme
 
äom
 
a
 
f•©h
. 
U£d
 
to
 
id’tify
 
which
 
sÚgs


46 
have
 
®»ady
 
b“n
 
fšg”´š‹d
 
Ú
 
disk
.

48  
os
.
·th
.
	`¥l™ext
(os.·th.
	`ba£Çme
(path))[0]

	@fingerprint.py

1 
impÜt
 
numpy
 
as
 
Å


2 
impÜt
 
	gm©¶Ùlib
.
mÏb
 
as
 mlab

3 
impÜt
 
	gm©¶Ùlib
.
py¶Ù
 
as
 
¶t


4 
äom
 
	gscy
.
	gndimage
.
f‹rs
 
impÜt
 
maximum_f‹r


5 
äom
 
	gscy
.
	gndimage
.
mÜphŞogy
 
	$impÜt
 (
g’”©e_bš¬y_¡ruùu»
,

6 
™”©e_¡ruùu»
, 
bš¬y_”osiÚ
)

7 
impÜt
 
hashlib


8 
äom
 
İ”©Ü
 
impÜt
 
™emg‘‹r


10 
IDX_FREQ_I
 = 0

11 
IDX_TIME_J
 = 1

14 #Sam¶šg 
¿‹
, 
»Ï‹d
 
to
 
the
 
Nyqui¡
 
cÚd™iÚs
, 
which
 
afãùs


15 #th
¿nge
 
äequ’c›s
 
we
 
ÿn
 
d‘eù
.

16 
DEFAULT_FS
 = 44100

19 #Siz
of
 
the
 
FFT
 
wšdow
, 
afãùs
 
äequ’cy
 
g¿nuÏr™y


20 
DEFAULT_WINDOW_SIZE
 = 4096

23 #R©iØ
by
 
which
 
—ch
 
£qu’tŸl
 
wšdow
 
ov”Ïps
 
the
 
Ï¡
 
ªd
he

24 #Ãxˆ
wšdow
. 
High”
 
ov”Ïp
 
wl
 
®low
 
a
 
high”
 
g¿nuÏr™y
 
of
 
off£t


25 #m©chšg, 
but
 
pÙ’tŸÎy
 
mÜe
 
fšg”´šts
.

26 
DEFAULT_OVERLAP_RATIO
 = 0.5

29 #Deg»
to
 
which
 
a
 
fšg”´št
 
ÿn
 
be
 
·œed
 
w™h
 
™s
 
ÃighbÜs
 --

30 #high” 
wl
 
ÿu£
 
mÜe
 
fšg”´šts
, 
but
 
pÙ’tŸÎy
 
b‘‹r
 
accu¿cy
.

31 
DEFAULT_FAN_VALUE
 = 15

34 #Mšimum 
am¶™ude
 
š
 
¥eùrog¿m
 iÀ
Üd”
 
to
 
be
 
cÚsid”ed
 
a
 
³ak
.

35 #Thi 
ÿn
 
be
 
¿i£d
 
to
 
»duû
 
numb”
 
of
 
fšg”´šts
, 
but
 cª 
Ãg©iv–y


36 #afãù 
accu¿cy
.

37 
DEFAULT_AMP_MIN
 = 10

40 #Numb” 
of
 
ûÎs
 
¬ound
 
ª
 
am¶™ude
 
³ak
 
š
 
the
 
¥eùrog¿m
 iÀ
Üd”


41 #fÜ 
Dejavu
 
to
 
cÚsid”
 
™
 
a
 
¥eù¿l
 
³ak
. 
High”
 
v®ues
 
m—n
 
Ëss


42 #fšg”´št 
ªd
 
ç¡”
 
m©chšg
, 
but
 
ÿn
 
pÙ’tŸÎy
 
afãù
 
accu¿cy
.

43 
PEAK_NEIGHBORHOOD_SIZE
 = 20

46 #Th»shŞd 
Ú
 
how
 
şo£
 
Ü
 
çr
 
fšg”´šts
 
ÿn
 
be
 
š
 
time
 iÀ
Üd”


47 #tØ
be
 
·œed
 
as
 
a
 
fšg”´št
. 
If
 
your
 
max
 
is
 
too
 
low
, 
high”
 
v®ues
 
of


48 #DEFAULT_FAN_VALUE 
may
 
nÙ
 
³rfÜm
 
as
 
ex³ùed
.

49 
MIN_HASH_TIME_DELTA
 = 0

50 
MAX_HASH_TIME_DELTA
 = 200

53 #Ià
True
, 
wl
 
sÜt
 
³aks
 
‹mpÜ®ly
 
fšg”´štšg
;

54 #nÙ 
sÜtšg
 
wl
 
cut
 
down
 
numb”
 
of
 
fšg”´šts
, 
but
 
pÙ’tŸÎy


55 #afãù 
³rfÜmªû
.

56 
PEAK_SORT
 = 
True


59 #Numb” 
of
 
b™s
 
to
 
throw
 
away
 
äom
 
the
 
äÚt
 oàth
SHA1
 
hash
 
š
he

60 #fšg”´šˆ
ÿlcuÏtiÚ
. 
The
 
mÜe
 
you
 
throw
 
away
, 
the
 
Ëss
 
¡Üage
, 
but


61 #pÙ’tŸÎy 
high”
 
cŞlisiÚs
 
ªd
 
misşassifiÿtiÚs
 
wh’
 
id’tifyšg
 
sÚgs
.

62 
FINGERPRINT_REDUCTION
 = 20

64 
def
 
	$fšg”´št
(
chªÃl_§m¶es
, 
Fs
=
DEFAULT_FS
,

65 
wsize
=
DEFAULT_WINDOW_SIZE
,

66 
w¿tio
=
DEFAULT_OVERLAP_RATIO
,

67 
çn_v®ue
=
DEFAULT_FAN_VALUE
,

68 
amp_mš
=
DEFAULT_AMP_MIN
):

70 
FFT
 
the
 
chªÃl
, 
log
 
ŒªsfÜm
 
ouut
, 
fšd
 
loÿl
 
maxima
, 
th’
 

71 
loÿÎy
 
£ns™ive
 
hashes
.

73 #FFT 
the
 
sigÇl
 
ªd
 
exŒaù
 
äequ’cy
 
compÚ’ts


74 
¬r2D
 = 
mÏb
.
	`¥ecg¿m
(

75 
chªÃl_§m¶es
,

76 
NFFT
=
wsize
,

77 
Fs
=Fs,

78 
wšdow
=
mÏb
.
wšdow_hªnšg
,

79 
nov”Ïp
=(
wsize
 * 
w¿tio
))[0]

81 #­¶y 
log
 
ŒªsfÜm
 
sšû
 
	`¥ecg¿m
(è
»tuºs
 
lš—r
 
¬¿y


82 
¬r2D
 = 10 * 
Å
.
	$log10
(
¬r2D
)

83 
¬r2D
[¬r2D =ğ-
Å
.
šf
] = 0 #»¶aû 
šfs
 
w™h
 
z”os


85 #fšd 
loÿl
 
maxima


86 
loÿl_maxima
 = 
	$g‘_2D_³aks
(
¬r2D
, 
¶Ù
=
F®£
, 
amp_mš
=amp_min)

88 #»tuº 
hashes


89  
	$g’”©e_hashes
(
loÿl_maxima
, 
çn_v®ue
=fan_value)

92 
def
 
	$g‘_2D_³aks
(
¬r2D
, 
¶Ù
=
F®£
, 
amp_mš
=
DEFAULT_AMP_MIN
):

94 ğ
	`g’”©e_bš¬y_¡ruùu»
(2, 1)

95 
ÃighbÜhood
 = 
	$™”©e_¡ruùu»
(, 
PEAK_NEIGHBORHOOD_SIZE
)

97 #fšd 
loÿl
 
maxima
 
usšg
 
our
 
æ™”
 
sh­e


98 
loÿl_max
 = 
	`maximum_f‹r
(
¬r2D
, 
foÙ´št
=
ÃighbÜhood
) ==‡rr2D

99 
background
 = (
¬r2D
 == 0)

100 
”oded_background
 = 
	`bš¬y_”osiÚ
(
background
, 
¡ruùu»
=
ÃighbÜhood
,

101 
bÜd”_v®ue
=1)

103 #BoŞ—À
mask
 
of
 
¬r2D
 
w™h
 
True
 
©
 
³aks


104 
d‘eùed_³aks
 = 
loÿl_max
 - 
”oded_background


106 #exŒaù 
³aks


107 
amps
 = 
¬r2D
[
d‘eùed_³aks
]

108 
j
, 
i
 = 
Å
.
	$wh”e
(
d‘eùed_³aks
)

110 #f‹¸
³aks


111 
amps
 =‡mps.
	$æ©‹n
()

112 
³aks
 = 
	$z
(
i
, 
j
, 
amps
)

113 
³aks_f‹»d
 = [
x
 x 
š
 
³aks
 x[2] > 
amp_mš
] #äeq, 
time
, 
amp


115 #g‘ 
šdiûs
 
äequ’cy
 
ªd
 
time


116 
äequ’cy_idx
 = [
x
[1] x 
š
 
³aks_f‹»d
]

117 
time_idx
 = [
x
[0] x 
š
 
³aks_f‹»d
]

119 
¶Ù
:

120 #sÿ‰” 
of
 
the
 
³aks


121 
fig
, 
ax
 = 
¶t
.
	$sub¶Ùs
()

122 
ax
.
	$imshow
(
¬r2D
)

123 
ax
.
	$sÿ‰”
(
time_idx
, 
äequ’cy_idx
)

124 
ax
.
	`£t_xÏb–
('Time')

125 
ax
.
	`£t_yÏb–
('Frequency')

126 
ax
.
	`£t_t™Ë
("Spectrogram")

127 
¶t
.
	`gÿ
().
	$šv”t_yaxis
()

128 
¶t
.
	$show
()

130  
	$z
(
äequ’cy_idx
, 
time_idx
)

133 
def
 
	$g’”©e_hashes
(
³aks
, 
çn_v®ue
=
DEFAULT_FAN_VALUE
):

135 
Hash
 
li¡
 
¡ruùu»
:

136 
sha1_hash
[0:20] 
time_off£t


137 [(
e05b341a9b77a51fd26
, 32), ... ]

139 
fšg”´š‹d
 = 
	$£t
(è#tØ
avoid
 
»hashšg
 
§me
 
·œs


141 
PEAK_SORT
:

142 
³aks
.
	`sÜt
(
key
=
	`™emg‘‹r
(1))

144 
i
 
š
 
	`¿nge
(
	$Ën
(
³aks
)):

145 
j
 
š
 
	`¿nge
(1, 
çn_v®ue
):

146 ià(
i
 + 
j
è< 
	$Ën
(
³aks
è
ªd
 
	`nÙ
 (
i
, i + 
j
è
š
 
fšg”´š‹d
:

147 
äeq1
 = 
³aks
[
i
][
IDX_FREQ_I
]

148 
äeq2
 = 
³aks
[
i
 + 
j
][
IDX_FREQ_I
]

150 
t1
 = 
³aks
[
i
][
IDX_TIME_J
]

151 
t2
 = 
³aks
[
i
 + 
j
][
IDX_TIME_J
]

153 
t_d–
 = 
t2
 - 
t1


155 
t_d–
 >ğ
MIN_HASH_TIME_DELTA
 
ªd
_d– <ğ
MAX_HASH_TIME_DELTA
:

156 
h
 = 
hashlib
.
	`sha1
(

157 "%s|%s|%s" % (
	`¡r
(
äeq1
), sŒ(
äeq2
), 
	$¡r
(
t_d–
)))

158 
	`y›ld
 (
h
.
	`hexdige¡
()[0:
FINGERPRINT_REDUCTION
], 
t1
)

160 #’su» 
we
 
dÚ
't„epeat hashing

161 
fšg”´š‹d
.
	`add
((
i
, i + 
j
))

	@recognize.py

1 
impÜt
 
	gdejavu
.
fšg”´št
 
as
 fingerprint

2 
impÜt
 
	gdejavu
.
decod”
 
as
 decoder

3 
impÜt
 
numpy
 
as
 
Å


4 
impÜt
 
pyaudio


5 
impÜt
 
time


8 
şass
 
	$Ba£Recogniz”
(
objeù
):

10 
def
 
	$__š™__
(
£lf
, 
dejavu
):

11 
£lf
.
dejavu
 = dejavu

12 
£lf
.
Fs
 = 
fšg”´št
.
DEFAULT_FS


14 
def
 
	$_»cognize
(
£lf
, *
d©a
):

15 
m©ches
 = []

16 
d
 
š
 
d©a
:

17 
m©ches
.
	`ex‹nd
(
£lf
.
dejavu
.
	$fšd_m©ches
(
d
, 
Fs
=
£lf
.Fs))

18  
£lf
.
dejavu
.
	$®ign_m©ches
(
m©ches
)

20 
def
 
	$»cognize
(
£lf
):

21 
·ss
 #ba£ 
şass
 
dÛs
 
nÙhšg


24 
şass
 
	$FeRecogniz”
(
Ba£Recogniz”
):

25 
def
 
	$__š™__
(
£lf
, 
dejavu
):

26 
	`su³r
(
FeRecogniz”
, 
£lf
).
	$__š™__
(
dejavu
)

28 
def
 
	$»cognize_fe
(
£lf
, 
f’ame
):

29 
äames
, 
£lf
.
Fs
 = 
decod”
.
	$»ad
(
f’ame
, 
£lf
.
dejavu
.
lm™
)

31 
t
 = 
time
.
	$time
()

32 
m©ch
 = 
£lf
.
	$_»cognize
(*
äames
)

33 
t
 = 
time
.
	`time
() -

35 
m©ch
:

36 
m©ch
['m©ch_time'] = 
t


38  
m©ch


40 
def
 
	$»cognize
(
£lf
, 
f’ame
):

41  
£lf
.
	$»cognize_fe
(
f’ame
)

44 
şass
 
	$MiüİhÚeRecogniz”
(
Ba£Recogniz”
):

45 
deçuÉ_chunksize
 = 8192

46 
deçuÉ_fÜm©
 = 
pyaudio
.
·IÁ16


47 
deçuÉ_chªÃls
 = 2

48 
deçuÉ_§m¶”©e
 = 44100

50 
def
 
	$__š™__
(
£lf
, 
dejavu
):

51 
	`su³r
(
MiüİhÚeRecogniz”
, 
£lf
).
	$__š™__
(
dejavu
)

52 
£lf
.
audio
 = 
pyaudio
.
	$PyAudio
()

53 
£lf
.
¡»am
 = 
NÚe


54 
£lf
.
d©a
 = []

55 
£lf
.
chªÃls
 = 
MiüİhÚeRecogniz”
.
deçuÉ_chªÃls


56 
£lf
.
chunksize
 = 
MiüİhÚeRecogniz”
.
deçuÉ_chunksize


57 
£lf
.
§m¶”©e
 = 
MiüİhÚeRecogniz”
.
deçuÉ_§m¶”©e


58 
£lf
.
»cÜded
 = 
F®£


60 
def
 
	$¡¬t_»cÜdšg
(
£lf
, 
chªÃls
=
deçuÉ_chªÃls
,

61 
§m¶”©e
=
deçuÉ_§m¶”©e
,

62 
chunksize
=
deçuÉ_chunksize
):

63 
£lf
.
chunksize
 = chunksize

64 
£lf
.
chªÃls
 = channels

65 
£lf
.
»cÜded
 = 
F®£


66 
£lf
.
§m¶”©e
 = samplerate

68 
£lf
.
¡»am
:

69 
£lf
.
¡»am
.
	$¡İ_¡»am
()

70 
£lf
.
¡»am
.
	$şo£
()

72 
£lf
.
¡»am
 = s–f.
audio
.
	$İ’
(

73 
fÜm©
=
£lf
.
deçuÉ_fÜm©
,

74 
chªÃls
=channels,

75 
¿‹
=
§m¶”©e
,

76 
šput
=
True
,

77 
äames_³r_bufãr
=
chunksize
,

80 
£lf
.
d©a
 = [[] 
i
 
š
 
	`¿nge
(
chªÃls
)]

82 
def
 
	$´oûss_»cÜdšg
(
£lf
):

83 
d©a
 = 
£lf
.
¡»am
.
	$»ad
(
£lf
.
chunksize
)

84 
nums
 = 
Å
.
	$äom¡ršg
(
d©a
, 
Å
.
št16
)

85 
c
 
š
 
	$¿nge
(
£lf
.
chªÃls
):

86 
£lf
.
d©a
[
c
].
	`ex‹nd
(
nums
[c::£lf.
chªÃls
])

88 
def
 
	$¡İ_»cÜdšg
(
£lf
):

89 
£lf
.
¡»am
.
	$¡İ_¡»am
()

90 
£lf
.
¡»am
.
	$şo£
()

91 
£lf
.
¡»am
 = 
NÚe


92 
£lf
.
»cÜded
 = 
True


94 
def
 
	$»cognize_»cÜdšg
(
£lf
):

95 
nÙ
 
£lf
.
»cÜded
:

96 
¿i£
 
	`NoRecÜdšgE¼Ü
("Recording was‚ot complete/begun")

97  
£lf
.
	$_»cognize
(*
£lf
.
d©a
)

99 
def
 
	$g‘_»cÜded_time
(
£lf
):

100  
	`Ën
(
£lf
.
d©a
[0]è/ s–f.
¿‹


102 
def
 
	`»cognize
(
£lf
, 
£cÚds
=10):

103 
£lf
.
	$¡¬t_»cÜdšg
()

104 
i
 
š
 
	`¿nge
(0, (
£lf
.
§m¶”©e
 / s–f.
chunksize


105 * 
£cÚds
)):

106 
£lf
.
	$´oûss_»cÜdšg
()

107 
£lf
.
	$¡İ_»cÜdšg
()

108  
£lf
.
	$»cognize_»cÜdšg
()

111 
şass
 
	$NoRecÜdšgE¼Ü
(
Exû±iÚ
):

112 
·ss


	@testing.py

1 
äom
 
__futu»__
 
impÜt
 
divisiÚ


2 
äom
 
pydub
 
impÜt
 
AudioSegm’t


3 
äom
 
	gdejavu
.
decod”
 
impÜt
 
·th_to_sÚgÇme


4 
äom
 
dejavu
 
impÜt
 
Dejavu


5 
äom
 
	gdejavu
.
fšg”´št
 
impÜt
 *

6 
impÜt
 
Œaûback


7 
impÜt
 
âm©ch


8 
impÜt
 
	gos
, 
	g»
, 
a¡


9 
impÜt
 
sub´oûss


10 
impÜt
 
¿ndom


11 
impÜt
 
loggšg


13 
def
 
	$£t_£ed
(
£ed
=
NÚe
):

15 `
£ed
` 
as
 
NÚe
 
m—ns
 
th©
 
the
 
§m¶šg
 
wl
 
be
 
¿ndom
.

17 
S‘tšg
 
your
 
own
 
£ed
 
m—ns
 
th©
 
you
 
ÿn
 
´oduû
 
the


18 
§me
 
ex³rim’t
 
ov”
 
ªd
 over.

20 
£ed
 !ğ
NÚe
:

21 
¿ndom
.
	$£ed
(
£ed
)

23 
def
 
	$g‘_fes_»cursive
(
¤c
, 
fmt
):

25 `
¤c
` 
is
 
the
 
sourû
 
dœeùÜy
.

26 `
fmt
` 
is
 
the
 
ex‹nsiÚ
, 
›
 ".mp3" 
Ü
 "mp3", 
‘c
.

28 
roÙ
, 
dœÇmes
, 
f’ames
 
š
 
os
.
	$w®k
(
¤c
):

29 
f’ame
 
š
 
âm©ch
.
	`f‹r
(
f’ames
, '*' + 
fmt
):

30 
y›ld
 
os
.
·th
.
	$još
(
roÙ
, 
f’ame
)

32 
def
 
	$g‘_Ëngth_audio
(
audiİ©h
, 
ex‹nsiÚ
):

34 
R‘uºs
 
Ëngth
 
of
 
audio
 
š
 
£cÚds
.

35 
R‘uºs
 
NÚe
 
fÜm©
 
i¢
't supported or in case ofƒrror.

37 
Œy
:

38 
audio
 = 
AudioSegm’t
.
	`äom_fe
(
audiİ©h
, 
ex‹nsiÚ
.
	`»¶aû
(".", ""))

39 
exû±
:

40 
´št
 "E¼Ü iÀg‘_Ëngth_audio(): %s" % 
Œaûback
.
	$fÜm©_exc
()

41  
NÚe


42  (
	`Ën
(
audio
) / 1000.0)

44 
def
 
	$g‘_¡¬‰ime
(
Ëngth
, 
n£cÚds
, 
·ddšg
):

46 `
Ëngth
` 
is
 
tÙ®
 
audio
†’gth 
š
 
£cÚds


47 `
n£cÚds
` 
is
 
amouÁ
 
of
 
time
 
to
 
§m¶e
 
š
 
£cÚds


48 `
·ddšg
` 
is
 
off
-
lim™s
 
£cÚds
 
©
 
begšnšg
 
ªd
 
’dšg


50 
maximum
 = 
Ëngth
 - 
·ddšg
 - 
n£cÚds


51 
·ddšg
 > 
maximum
:

53  
¿ndom
.
	$¿ndšt
(
·ddšg
, 
maximum
)

55 
def
 
	`g’”©e_‹¡_fes
(
¤c
, 
de¡
, 
n£cÚds
, 
fmts
=[".mp3", ".wav"], 
·ddšg
=10):

57 
G’”©es
 
a
 
‹¡
 
fe
 
—ch
 f
»cursiv–y
 
š
 `
¤c
` 
dœeùÜy


58 
of
 
giv’
 
fÜm©
 
usšg
 `
n£cÚds
` 
§m¶ed
 
äom
 
the
 
audio
 
fe
.

60 
ResuÉs
 
¬e
 
wr™‹n
 
to
 `
de¡
` 
dœeùÜy
.

62 `
·ddšg
` 
is
 
the
 
numb”
 
of
 
off
-
lim™
 
£cÚds
 
ªd
h
begšnšg
‡nd

63 
’d
 
of
 
a
 
Œack
 
th©
 
wÚ
't be sampled inesting. Often you wanto

64 
avoid
 
s’û
, 
‘c
.

66 #ü—‹ 
dœeùÜ›s
 
Ãûs§ry


67 
dœeùÜy
 
š
 [
¤c
, 
de¡
]:

68 
Œy
:

69 
os
.
	$¡©
(
dœeùÜy
)

70 
exû±
:

71 
os
.
	$mkdœ
(
dœeùÜy
)

73 #fšd 
fes
 
»cursiv–y
 
of
 
a
 
giv’
 
fe
 
fÜm©


74 
fmt
 
š
 
fmts
:

75 
‹¡sourûs
 = 
	$g‘_fes_»cursive
(
¤c
, 
fmt
)

76 
audiosourû
 
š
 
‹¡sourûs
:

78 
´št
 "audiosourû:", 
audiosourû


80 
f’ame
, 
ex‹nsiÚ
 = 
os
.
·th
.
	`¥l™ext
(os.·th.
	$ba£Çme
(
audiosourû
))

81 
Ëngth
 = 
	$g‘_Ëngth_audio
(
audiosourû
, 
ex‹nsiÚ
)

82 
¡¬‰ime
 = 
	$g‘_¡¬‰ime
(
Ëngth
, 
n£cÚds
, 
·ddšg
)

84 
‹¡_fe_Çme
 = "%s_%s_%ssec.%s" % (

85 
os
.
·th
.
	`još
(
de¡
, 
f’ame
), 
¡¬‰ime
,

86 
n£cÚds
, 
ex‹nsiÚ
.
	`»¶aû
(".", ""))

88 
sub´oûss
.
	`check_ouut
([

90 "-ss", "%d" % 
¡¬‰ime
,

91 '-t' , "%d" % 
n£cÚds
,

92 "-i", 
audiosourû
,

93 
‹¡_fe_Çme
])

95 
def
 
	$log_msg
(
msg
, 
log
=
True
, 
s’t
=
F®£
):

96 
log
:

97 
loggšg
.
	$debug
(
msg
)

98 
nÙ
 
s’t
:

99 
´št
 
msg


101 
def
 
	$autŞab–
(
»ùs
, 
ax
):

102 #©ch 
some
 
‹xt
 
Ïb–s


103 
»ù
 
š
 
»ùs
:

104 
height
 = 
»ù
.
	$g‘_height
()

105 
ax
.
	`‹xt
(
»ù
.
	`g‘_x
(è+„eù.
	`g‘_width
(è/ 2., 1.05 * 
height
,

106 '%d' % (
height
), 
ha
='ûÁ”', 
va
='bottom')

108 
def
 
	$autŞab–doubËs
(
»ùs
, 
ax
):

109 #©ch 
some
 
‹xt
 
Ïb–s


110 
»ù
 
š
 
»ùs
:

111 
height
 = 
»ù
.
	$g‘_height
()

112 
ax
.
	`‹xt
(
»ù
.
	`g‘_x
(è+„eù.
	`g‘_width
(è/ 2., 1.05 * 
height
,

113 '%s' % 
	`round
((
height
), 3), 
ha
='ûÁ”', 
va
='bottom')

115 
şass
 
	$DejavuTe¡
(
objeù
):

116 
def
 
	$__š™__
(
£lf
, 
fŞd”
, 
£cÚds
):

117 
	`su³r
(
DejavuTe¡
, 
£lf
).
	$__š™__
()

119 
£lf
.
‹¡_fŞd”
 = 
fŞd”


120 
£lf
.
‹¡_£cÚds
 = 
£cÚds


121 
£lf
.
‹¡_sÚgs
 = []

123 
´št
 "‹¡_£cÚds", 
£lf
.
‹¡_£cÚds


125 
£lf
.
‹¡_fes
 = [

126 
f
 à
š
 
os
.
	$li¡dœ
(
£lf
.
‹¡_fŞd”
)

127 
os
.
·th
.
	`isfe
(os.·th.
	$još
(
£lf
.
‹¡_fŞd”
, 
f
))

128 
ªd
 
»
.
	`fšd®l
("[0-9]*£c", 
f
)[0] 
š
 
£lf
.
‹¡_£cÚds
]

130 
´št
 "‹¡_fes", 
£lf
.
‹¡_fes


132 
£lf
.
n_cŞumns
 = 
	$Ën
(
£lf
.
‹¡_£cÚds
)

133 
£lf
.
n_lšes
 = (
	`Ën
(£lf.
‹¡_fes
è/ s–f.
n_cŞumns
)

135 
´št
 "cŞumns:", 
£lf
.
n_cŞumns


136 
´št
 "Ëngth oà‹¡ fes:", 
	$Ën
(
£lf
.
‹¡_fes
)

137 
´št
 "lšes:", 
£lf
.
n_lšes


139 #v¬ŸbË 
m©ch
 
	`»suÉs
 (
yes
, 
no
, 
šv®id
)

140 
£lf
.
»suÉ_m©ch
 = [[0 
x
 
š
 
	`x¿nge
(£lf.
n_cŞumns
)] x iÀx¿nge(£lf.
n_lšes
)]

142 
´št
 "»suÉ_m©ch m©rix:", 
£lf
.
»suÉ_m©ch


144 #v¬ŸbË 
m©ch
 
	`´ecisiÚ
 (
m©ched
 
š
 
the
 
cÜ»ùed
 
time
)

145 
£lf
.
»suÉ_m©chšg_times
 = [[0 
x
 
š
 
	`x¿nge
(£lf.
n_cŞumns
)] x iÀx¿nge(£lf.
n_lšes
)]

147 #v¬ŸbË 
mahšg
 
	`time
 (
qu”y
 
time
)

148 
£lf
.
»suÉ_qu”y_du¿tiÚ
 = [[0 
x
 
š
 
	`x¿nge
(£lf.
n_cŞumns
)] x iÀx¿nge(£lf.
n_lšes
)]

150 #v¬ŸbË 
cÚfid’û


151 
£lf
.
»suÉ_m©ch_cÚfid’û
 = [[0 
x
 
š
 
	`x¿nge
(£lf.
n_cŞumns
)] x iÀx¿nge(£lf.
n_lšes
)]

153 
£lf
.
	$begš
()

155 
def
 
	$g‘_cŞumn_id
 (
£lf
, 
£cs
):

156 
i
, 
£c
 
š
 
	$’um”©e
(
£lf
.
‹¡_£cÚds
):

157 
£cs
 =ğ
£c
:

158  
i


160 
def
 
	$g‘_lše_id
 (
£lf
, 
sÚg
):

161 
i
, 
s
 
š
 
	$’um”©e
(
£lf
.
‹¡_sÚgs
):

162 
sÚg
 =ğ
s
:

163  
i


164 
£lf
.
‹¡_sÚgs
.
	$­³nd
(
sÚg
)

165  
	`Ën
(
£lf
.
‹¡_sÚgs
) - 1

167 
def
 
	$ü—‹_¶Ùs
(
£lf
, 
Çme
, 
»suÉs
, 
»suÉs_fŞd”
):

168 
£c
 
š
 
	`¿nge
(0, 
	$Ën
(
£lf
.
‹¡_£cÚds
)):

169 
šd
 = 
Å
.
	$¬ªge
(
£lf
.
n_lšes
è#
 = 0.25 #thwidth oàthb¬s

171 
fig
 = 
¶t
.
	$figu»
()

172 
ax
 = 
fig
.
	`add_sub¶Ù
(111)

173 
ax
.
	`£t_xlim
([-1 * 
width
, 2 * width])

175 
m—ns_dvj
 = [
x
[0] x 
š
 
»suÉs
[
£c
]]

176 
»ùs1
 = 
ax
.
	`b¬
(
šd
, 
m—ns_dvj
, 
width
, 
cŞÜ
='r')

178 #add 
some


179 
ax
.
	$£t_yÏb–
(
Çme
)

180 
ax
.
	`£t_t™Ë
("% % ResuÉs" % (
£lf
.
‹¡_£cÚds
[
£c
], 
Çme
))

181 
ax
.
	`£t_xticks
(
šd
 + 
width
)

183 
Ïb–s
 = [0 
x
 
š
 
	`¿nge
(0, 
£lf
.
n_lšes
)]

184 
x
 
š
 
	`¿nge
(0, 
£lf
.
n_lšes
):

185 
Ïb–s
[
x
] = "song %s" % (x+1)

186 
ax
.
	$£t_xtickÏb–s
(
Ïb–s
)

188 
box
 = 
ax
.
	$g‘_pos™iÚ
()

189 
ax
.
	`£t_pos™iÚ
([
box
.
x0
, box.
y0
, box.
width
 * 0.75, box.
height
])

191 #ax.
	`Ëg’d
Ğ(
»ùs1
[0]), ('Dejavu'), 
loc
='ûÁ”†eá', 
bbox_to_ªchÜ
=(1, 0.5))

193 
Çme
 == 'Confidence':

194 
	$autŞab–
(
»ùs1
, 
ax
)

196 
	$autŞab–doubËs
(
»ùs1
, 
ax
)

198 
¶t
.
	$grid
()

200 
fig_Çme
 = 
os
.
·th
.
	`još
(
»suÉs_fŞd”
, "%s_%s.²g" % (
Çme
, 
£lf
.
‹¡_£cÚds
[
£c
]))

201 
fig
.
	$§vefig
(
fig_Çme
)

203 
def
 
	$begš
(
£lf
):

204 
f
 
š
 
£lf
.
‹¡_fes
:

205 
	`log_msg
('--------------------------------------------------')

206 
	`log_msg
('fe: %s' % 
f
)

208 #g‘ 
cŞumn


209 
cŞ
 = 
£lf
.
	`g‘_cŞumn_id
(
»
.
	`fšd®l
("[0-9]*£c",
f
)[0])

210 
sÚg
 = 
	`·th_to_sÚgÇme
(
f
).
	`¥l™
("_")[0] #fÜm©: 
XXXX_off£t_Ëngth
.
mp3


211 
lše
 = 
£lf
.
	$g‘_lše_id
 (
sÚg
)

212 
»suÉ
 = 
sub´oûss
.
	`check_ouut
(["pythÚ", "dejavu.py", '»cognize', 'fe', 
£lf
.
‹¡_fŞd”
 + "/" + 
f
])

214 
»suÉ
.
	`¡r
() == "None":

215 
	`log_msg
('No match')

216 
£lf
.
»suÉ_m©ch
[
lše
][
cŞ
] = 'no'

217 
£lf
.
»suÉ_m©chšg_times
[
lše
][
cŞ
] = 0

218 
£lf
.
»suÉ_qu”y_du¿tiÚ
[
lše
][
cŞ
] = 0

219 
£lf
.
»suÉ_m©ch_cÚfid’û
[
lše
][
cŞ
] = 0

222 
»suÉ
 =„esuÉ.
	$¡r
()

223 
»suÉ
 =„esuÉ.
	`»¶aû
(" \'", ' "')

224 
»suÉ
 =„esuÉ.
	`»¶aû
("{\'", '{"')

225 
»suÉ
 =„esuÉ.
	`»¶aû
("\':", '":')

226 
»suÉ
 =„esuÉ.
	`»¶aû
("\',", '",')

228 #which 
sÚg
 
did
 
we
 
´ediù
?

229 
»suÉ
 = 
a¡
.
	$l™”®_ev®
(
»suÉ
)

230 
sÚg_»suÉ
 = 
»suÉ
["song_name"]

231 
	`log_msg
('sÚg: %s' % 
sÚg
)

232 
	`log_msg
('sÚg_»suÉ: %s' % 
sÚg_»suÉ
)

234 
sÚg_»suÉ
 !ğ
sÚg
:

235 
	`log_msg
('invalid match')

236 
£lf
.
»suÉ_m©ch
[
lše
][
cŞ
] = 'invalid'

237 
£lf
.
»suÉ_m©chšg_times
[
lše
][
cŞ
] = 0

238 
£lf
.
»suÉ_qu”y_du¿tiÚ
[
lše
][
cŞ
] = 0

239 
£lf
.
»suÉ_m©ch_cÚfid’û
[
lše
][
cŞ
] = 0

241 
	`log_msg
('correct match')

242 
´št
 
£lf
.
»suÉ_m©ch


243 
£lf
.
»suÉ_m©ch
[
lše
][
cŞ
] = 'yes'

244 
£lf
.
»suÉ_qu”y_du¿tiÚ
[
lše
][
cŞ
] = 
	`round
(
»suÉ
[
Dejavu
.
MATCH_TIME
],3)

245 
£lf
.
»suÉ_m©ch_cÚfid’û
[
lše
][
cŞ
] = 
»suÉ
[
Dejavu
.
CONFIDENCE
]

247 
sÚg_¡¬t_time
 = 
»
.
	`fšd®l
("\_[^\_]+",
f
)

248 
sÚg_¡¬t_time
 = sÚg_¡¬t_time[0].
	`l¡r
("_ ")

250 
»suÉ_¡¬t_time
 = 
	`round
((
»suÉ
[
Dejavu
.
OFFSET
] * 
DEFAULT_WINDOW_SIZE
 *

251 
DEFAULT_OVERLAP_RATIO
è/ (
DEFAULT_FS
), 0)

253 
£lf
.
»suÉ_m©chšg_times
[
lše
][
cŞ
] = (
»suÉ_¡¬t_time
è- (
sÚg_¡¬t_time
)

254 ià(
	`abs
(
£lf
.
»suÉ_m©chšg_times
[
lše
][
cŞ
]) == 1):

255 
£lf
.
»suÉ_m©chšg_times
[
lše
][
cŞ
] = 0

257 
	`log_msg
('qu”y du¿tiÚ: %s' % 
	`round
(
»suÉ
[
Dejavu
.
MATCH_TIME
],3))

258 
	`log_msg
('cÚfid’û: %s' % 
»suÉ
[
Dejavu
.
CONFIDENCE
])

259 
	`log_msg
('sÚg s¹_time: %s' % 
sÚg_¡¬t_time
)

260 
	`log_msg
('»suÉ s¹ime: %s' % 
»suÉ_¡¬t_time
)

261 ià(
£lf
.
»suÉ_m©chšg_times
[
lše
][
cŞ
] == 0):

262 
	`log_msg
('accurate match')

264 
	`log_msg
('inaccurate match')

265 
	`log_msg
('--------------------------------------------------\n')

	@
1
.
0
7
90
__init__.py
database.py
database_sql.py
decoder.py
fingerprint.py
recognize.py
testing.py
