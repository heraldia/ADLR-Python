<!doctype html>
<html lang="en">
<head>
<title>LOS demo</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
<script src="js/Three.js"></script>
<script src="js/OBJLoader.js"></script>
<script src="js/Detector.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/Tween.js"></script>
<script src="js/jquery.min.js"></script>
<!-- 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
 -->
<h2>
<dir id = "action" > Steps: </dir>
</h2>
<div id="ThreeJS" style="position: absolute; left:-500px; top:-100px"></div>
<script>

var doAjax = function () {
    timerEgg.material =  new THREE.MeshLambertMaterial( { color: 0xff0000,  side : THREE.DoubleSide });
    $.ajax({
        url: "allIn1.json",
        async: true,   // asynchronous request? (synchronous requests are discouraged...)
        cache: false,   // with this, you can force the browser to not make cache of the retrieved data
        dataType: "text",  // jQuery will infer this, but you can set explicitly
        success: function( data, textStatus, jqXHR ) {
            var resourceContent = data; // can be a global variable too...
            // process the content...
//            console.log(resourceContent);
            reRender(resourceContent);
        }
    });
};

// standard global variables

var scene, camera, renderer;
var geometry, material, mesh;
var egg1;
var lightLevel;
var preStepCounter = 0;
var textId = document.getElementById("action");
var actionCounter = 0;
var preAccX = 40 ;
var preAccY, preAccZ;


init();
setInterval('doAjax()', 100); //millisecond
animate();

function reRender(wholeFile){

    var lines = wholeFile.split('\n');

    lineList = lines[0].split(',');
    rotate(lineList[5],lineList[4],lineList[6],lineList[10]);
//    initStepCounter = lineList[11];
/*  
     */
    if (lineList[0] < 10){
        color_temp = 0xff0000;}
    else if (lineList[0] >= 10 && lineList[0]< 14){
        color_temp = 0xff5f00;}
    else if (lineList[0]>= 14 && lineList[0] < 20){
        color_temp = 0xffff00;}
    else if (lineList[0] >= 20 && lineList[0] < 40){
        color_temp = 0x00ff00;}
    else if (lineList[0] >= 40 && lineList[0] < 80){
        color_temp = 0x00ffff;}
    else{
        color_temp = 0x0000ff;}
    egg1.material =  new THREE.MeshLambertMaterial( { color: color_temp,  side : THREE.DoubleSide });

    lightLevel.intensity = lineList[0]*.1;
        
    renderer.render( scene, camera );

    timerEgg.material =  new THREE.MeshLambertMaterial( { color: 0x00fff0,  side : THREE.DoubleSide });

    if (lineList[11] - preStepCounter > 0){
          steps = ""
          var temp = lineList[11] - preStepCounter;
          while (temp>0 && temp < 10){
          textId.innerText += "=-"
          actionCounter ++;
          temp --;
          }
          preStepCounter = lineList[11];
    }
    if (lineList[9] < -7 || lineList[9] > 7){
        textId.innerText += "]"
        actionCounter ++;
    }
    if (actionCounter > 187){
        textId.innerText = ""
        actionCounter = 0;
    }

    if (Math.pow(lineList[8]-preAccX, 2) + 
        Math.pow(lineList[9]-preAccY, 2) +
        Math.pow(lineList[10]-preAccY, 2) > 450){
        textId.innerText += "xxxx"
        actionCounter += 4;
    }else{
        preAccX = lineList[8];
        preAccY = lineList[9];
        preAccZ = lineList[10];
    }



}

function reRender1(wholeFile){

    var lines = wholeFile.split('\n');

    for(var line = 0; line < lines.length; line++){
        if (lines[line][0] == "S"){
            //      console.log(lines[line]);
            }
        if (lines[line][0] == "O") {
            lineList = lines[line].split(',');
            //rotate(lineList[1],lineList[2],lineList[3])
            //azimuth = lineList[1];
            //pitch   = lineList[2];
            //roll    = lineList[3];
            rotate(lineList[1],lineList[2],lineList[3]);
            }
        if (lines[line][0] == "L"){
        //console.log(lines[line]);
        lineList = lines[line].split(',')[1];
        //eggChange(lineList)
        if (lineList < 10){
            color_temp = 0xff0000;}
        else if (lineList >= 10 && lineList < 14){
            color_temp = 0xff5f00;}
        else if (lineList >= 14 && lineList < 20){
            color_temp = 0xffff00;}
        else if (lineList >= 20 && lineList < 40){
            color_temp = 0x00ff00;}
        else if (lineList >= 40 && lineList < 80){
            color_temp = 0x00ffff;}
        else{
            color_temp = 0x0000ff;}
        egg1.material =  new THREE.MeshLambertMaterial( { color: color_temp,  side : THREE.DoubleSide });
        lightLevel.intensity = lineList*.1;
        }
            renderer.render( scene, camera );

        }
    timerEgg.material =  new THREE.MeshLambertMaterial( { color: 0x00fff0,  side : THREE.DoubleSide });

}

function init() {
    scene = new THREE.Scene();
	var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
    camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );
    //camera.position.z = 1000;
	scene.add(camera);
	camera.position.set(0,0,-600);
	camera.lookAt(scene.position);


	// RENDERER ===================================
	if ( Detector.webgl )
		renderer = new THREE.WebGLRenderer( {antialias:true} );
	else
		renderer = new THREE.CanvasRenderer();
	renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
	container = document.getElementById( 'ThreeJS' );
	container.appendChild( renderer.domElement );
	// CONTROLS //end
	controls = new THREE.OrbitControls( camera, renderer.domElement );

    // LIGHTs=========================================
	lightLevel = new THREE.PointLight(0xffffff,1,400,2);
	lightLevel.position.set(180,200,200);
	scene.add(lightLevel);
    /*
	//Sun
	var light = new THREE.PointLight(0xffffff,100,400,2);
	light.position.set(-80,150,0);
	scene.add(light);
	//Volcano
	var volLight = new THREE.PointLight(0xff8800,300,500,2);//Gentle orange bask.
	volLight.position.set(0,200,200);
	scene.add(volLight);//Mostly illuminating the Dino.
    var lightHemi = new THREE.HemisphereLight( 0xffffbb, 0x080820, 0.5 );
    scene.add( lightHemi);
    */
	//Ambient
	var ambLight = new THREE.AmbientLight(0xffffff);
	scene.add(ambLight);
    /*
    //lightLevel
    var directionalLight = new THREE.DirectionalLight( 0xffffff, 1 );
    directionalLight.position.set( -300, 20 , 0 );
    scene.add( directionalLight );

         */
         //=====================================================

    //=====================================================
	var imagePrefix = "images/skybox/";
	var directions  =
        ["door-design-ideas-16", "window", "py", "apt", "stylish", "window-nook"];
	var imageSuffix = ".jpg";
	var skyGeometry = new THREE.CubeGeometry( 800, 500, 500 );

//========================================================

	var materialArray = [];
	for (var i = 0; i < 6; i++)
		materialArray.push( new THREE.MeshLambertMaterial({
			map: THREE.ImageUtils.loadTexture( imagePrefix + directions[i] + imageSuffix ),
			side: THREE.BackSide
		}));
	var skyMaterial = new THREE.MeshFaceMaterial( materialArray );
	var skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
	scene.add( skyBox );
//========================================================
	var imagePrefix = "images/";
	var directions  = ["side", "side", "front", "rear", "side", "side"];
	var imageSuffix = ".png";

	var materialArray = [];
	for (var i = 0; i < 6; i++)
		materialArray.push( new THREE.MeshLambertMaterial({
			map: THREE.ImageUtils.loadTexture( imagePrefix + directions[i] + imageSuffix ),
		}));
	var phone = new THREE.MeshFaceMaterial( materialArray );

        texture = THREE.ImageUtils.loadTexture('images\\front.png');
        geometry = new THREE.BoxGeometry( 100, 10, 200 );
//        material = new THREE.MeshLambertMaterial({map: texture});
        //material = new THREE.MeshLambertMaterial( { color: 0xff0000} );

        mesh = new THREE.Mesh( geometry, phone );

        mesh.position.x = -50;
        mesh.position.y = 150;
        scene.add( mesh );

//========================================================
    var radius = 20;
    var	segments = 20;
    var	rings = 10;

    // create the sphere's material
    var sphereMaterial = new THREE.MeshLambertMaterial( { color: 0xd9b62b, side : THREE.DoubleSide });

        egg1 = new THREE.Mesh(
            new THREE.SphereGeometry(
                radius,
                segments,
                rings),
            sphereMaterial);

        egg1.position.x = 200;
        egg1.position.y = -230;
        egg1.position.z = -230;

        scene.add(egg1);
//========================================================
    // create the sphere's material
    var sphereMaterial = new THREE.MeshLambertMaterial( { color: 0xd9b62b, side : THREE.DoubleSide });

        timerEgg = new THREE.Mesh(
            new THREE.SphereGeometry(
                radius,
                segments,
                rings),
            sphereMaterial);

        timerEgg.position.x = -200;
        timerEgg.position.y = -230;
        timerEgg.position.z = -230;

        scene.add(timerEgg);
	//Tween
	var startRotation3 = {x:-30, y:0, z:0};//We're going to make these all slightly different so they don't all shake uniformly.
	var endRotation3 = {x:5,y:0,z:0};
	var	tween3 = new TWEEN.Tween(startRotation3).to(endRotation3, 60);
	tween3.onUpdate(function(){
		timerEgg.rotation.set(startRotation3.x, startRotation3.y, startRotation3.z);
	});
	tween3.repeat( Infinity );
	tween3.start();

//========================================================
/*
FontUtils.loadFace(helvetiker_regular);
var textShapes = THREE.FontUtils.generateShapes( "Running" );
var text = new THREE.ShapeGeometry( textShapes );
var textMesh = new THREE.Mesh( text, new THREE.MeshLambertMaterial( { color: 0xff0000 } ) ) ;
    textMesh.position.x = -200;
    textMesh.position.y = -250;
    textMesh.position.z = -200;
scene.add(textMesh);
 */
//========================================================
 var material = new THREE.LineBasicMaterial({
        color: 0x0000ff
    });
   var geometry = new THREE.Geometry();
    geometry.vertices.push(new THREE.Vector3(0, -250, -250));
    geometry.vertices.push(new THREE.Vector3(0, -250, 70));
    geometry.vertices.push(new THREE.Vector3(100, -250, 70));
    var line = new THREE.Line(geometry, material);
    scene.add(line);
//========================================================
        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );

        document.body.appendChild( renderer.domElement );
        renderer.render( scene, camera );

//========================================================


} // end of init()

function rotate(pitch,azimuth,roll,zGravity) {
    if (zGravity > 0 ){
    mesh.rotation.x = pitch* Math.PI / 180;
    mesh.rotation.y = -1.0* azimuth* Math.PI / 180;
    mesh.rotation.z = -roll* Math.PI / 180;
    }
    else if (zGravity < 0){
    mesh.rotation.x = -pitch* Math.PI / 180;
    mesh.rotation.y = 1.0* azimuth* Math.PI / 180;
    mesh.rotation.z = roll* Math.PI / 180;
    }
   

    }

function update()
{
	controls.update();//Object orbity stuff. From threejs website.
}

function animate() {
    requestAnimationFrame( animate );
	TWEEN.update();//Shaking animation paths.
    renderer.render( scene, camera );
    update();
    }

/*  =============================trash
//    rotate(azimuth,pitch,roll);
document.getElementById("filex").onchange = function(){
var file = this.files[0];
var reader = new FileReader();
reader.onload = function(progressEvent){
    // Entire file
    wholeFile = this.result;
//    console.log(wholeFile);
    // By lines
    lines = this.result.split('\n');
            console.log("98");
    for(var line = 0; line < lines.length; line++){
            //console.log("100");
        if (lines[line][0] == "S"){
            //      console.log(lines[line]);
            }
        if (lines[line][0] == "O") {
            lineList = lines[line].split(',');
            //rotate(lineList[1],lineList[2],lineList[3])
            azimuth = lineList[1];
            pitch   = lineList[2];
            roll    = lineList[3];
            //sleep(500);
            rotate(lineList[1],lineList[2],lineList[3]);
            }
        if (lines[line][0] == "L"){
        //console.log(lines[line]);
        lineList = lines[line].split(',')[1];
        //eggChange(lineList)
        if (lineList < 5){
            color_temp = 0xff0000}
        else if (lineList > 5 && lineList < 10){
            color_temp = 0xffff00}
            else{
            color_temp = 0xff00ff}
        egg1.material =  new THREE.MeshLambertMaterial( { color: color_temp,  side : THREE.DoubleSide });
//            console.log("107");
        }
            renderer.render( scene, camera );

        }
    };
reader.readAsText(file);

//http://stackoverflow.com/questions/23331546/how-to-use-javascript-to-read-local-text-file-and-read-line-by-line
};
     */

function sleep(delay) {
        var start = new Date().getTime();
        while (new Date().getTime() < start + delay);
      }
</script>
</body>
</html>
