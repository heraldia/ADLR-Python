<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Three框架</title>
		<script src="js/Three.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
		<style type="text/css">
			div#canvas-frame {
				border: none;
				cursor: pointer;
				width: 100%;
				height: 600px;
				background-color: #EEEEEE;
			}

		</style>
		<script>

var doAjax = function () {
    $.ajax({
        url: "allIn1.json",
        async: true,   // asynchronous request? (synchronous requests are discouraged...)
        cache: false,   // with this, you can force the browser to not make cache of the retrieved data
        dataType: "text",  // jQuery will infer this, but you can set explicitly
        success: function( data, textStatus, jqXHR ) {
            var resourceContent = data; // can be a global variable too...
            // process the content...
//            console.log(resourceContent);
            reRender(resourceContent);
        }
    });
};

var startingX = 0;
var startingZ = 0;
var endingX = 0;
var endingZ = 0;
var prevStepCounter = 0; 
var startingColor = 0x004444;
var endingColor = 0xff0000;

function reRender(wholeFile){

    //console.log("41");
    var lines = wholeFile.split('\n');
    lineList = lines[0].split(',');

    /*  
    startingX = 100;
    startingZ = -100;
    endingX = -100;
    endingZ = 100;
         */

    computeLOS(lineList[0],lineList[4],lineList[10],lineList[11]);

}

function computeLOS(lightLevel, azimuth, zAccer, stepCounter){

    if (lightLevel < 10){
        endingColor = 0xff0000;}
    else if (lineList[0] >= 10 && lineList[0]< 14){
        endingColor = 0xff5f00;}
    else if (lineList[0]>= 14 && lineList[0] < 20){
        endingColor = 0xffff00;}
    else if (lineList[0] >= 20 && lineList[0] < 40){
        endingColor = 0x00ff00;}
    else if (lineList[0] >= 40 && lineList[0] < 80){
        endingColor = 0x00ffff;}
    else{
        endingColor = 0x0000ff;}


    detStepCounter = stepCounter - prevStepCounter;
    //console.log("58");
    if (detStepCounter > 0 && detStepCounter < 20 ) {
    detStepCounter *= 20;
    if (zAccer >=  0){
    angle = -1.0* azimuth* Math.PI / 180;
    }
    else {
    angle = 1.0* azimuth* Math.PI / 180;
    }
    endingX = startingX + Math.cos(angle) * detStepCounter;
    endingZ = startingZ + Math.sin(angle) * detStepCounter;
    console.log(startingX+ "," + startingZ + ","+ endingX + "," + endingZ);
    }
    prevStepCounter = stepCounter;
    //console.log(prevStepCounter+ "," + stepCounter);

}

            var renderer;
            function initThree() {
                width = document.getElementById('canvas-frame').clientWidth;
                height = document.getElementById('canvas-frame').clientHeight;
                renderer = new THREE.WebGLRenderer({
                    antialias : true
                });
                renderer.setSize(width, height);
                document.getElementById('canvas-frame').appendChild(renderer.domElement);
                renderer.setClearColor(0xFFFFFF, 1.0);
            }

            var camera;
            function initCamera() {
                camera = new THREE.PerspectiveCamera(45, width / height, 1, 10000);
                camera.position.x = 0;
                camera.position.y = 1000;
                camera.position.z = 0;
                camera.up.x = 0;
                camera.up.y = 0;
                camera.up.z = 1;
                camera.lookAt({
                    x : 0,
                    y : 0,
                    z : 0
                });
            }

            var scene;
            function initScene() {
                scene = new THREE.Scene();
            }

            var light;
            function initLight() {
                light = new THREE.DirectionalLight(0xFF0000, 1.0, 0);
                light.position.set(100, 100, 200);
                scene.add(light);
            }

            function initObject() {

                var geometry = new THREE.Geometry();
                var material = new THREE.LineBasicMaterial( {
vertexColors: true ,
linewidth : 10,
linecap : 'square'} );
                var color1 = new THREE.Color( 0x444444 ), color2 = new THREE.Color( 0xFF0000 );

                // 线的材质可以由2点的颜色决定
                var p1 = new THREE.Vector3( -100, 0, 100 );
                var p2 = new THREE.Vector3(  100, 0, -100 );
                geometry.vertices.push(p1);
                geometry.vertices.push(p2);
                geometry.colors.push( color1, color2 );

                var line = new THREE.Line( geometry, material );
                scene.add(line);
            }

            function render(){
                var geometry = new THREE.Geometry();
                var material = new THREE.LineBasicMaterial( {
vertexColors: true ,
linewidth : 10 ,
linecap : 'square'} );
                var color1 = new THREE.Color( startingColor ), color2 = new
                    THREE.Color( endingColor );

                // 线的材质可以由2点的颜色决定
                var p1 = new THREE.Vector3( startingX, 0, startingZ );
                var p2 = new THREE.Vector3(  endingX, 0, endingZ );
                geometry.vertices.push(p1);
                geometry.vertices.push(p2);
                geometry.colors.push( color1, color2 );

                var line = new THREE.Line( geometry, material );
                scene.add(line);
                startingX = endingX ; 
                startingZ = endingZ ; 
                startingColor = endingColor;
//    console.log("152");

                renderer.render( scene, camera );

            }

            function threeStart() {
                initThree();
                initCamera();
                initScene();
                initLight();
                //initObject();

                setInterval('doAjax()', 100); //millisecond
                renderer.clear();
                renderer.render(scene, camera);

                animate();
            }

            function animate() {

                requestAnimationFrame( animate );

                render();
            }

		</script>
	</head>

	<body onload="threeStart();">
		<div id="canvas-frame"></div>
	</body>
</html>
